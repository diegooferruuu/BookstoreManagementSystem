@page
@model LibraryWeb.Pages.Users.ChangePasswordModel
@{
    ViewData["Title"] = "Cambiar Contraseña";
}

<div class="card p-4 shadow-sm mt-3">
    <h3 class="mb-4 text-primary"><i class="fas fa-key me-2"></i>Cambiar Contraseña</h3>

    @if (Request.Query["first"] == "true")
    {
        <div class="alert alert-warning">
            <i class="fas fa-lock me-2"></i>
            Por seguridad, debes cambiar tu contraseña antes de continuar.
        </div>
    }

    <form method="post" id="changeForm" novalidate>
        <div class="mb-3">
            <label asp-for="CurrentPassword" class="form-label fw-semibold"></label>
            <input asp-for="CurrentPassword" type="password" class="form-control" placeholder="Ingresa tu contraseña actual" value="@Model.CurrentPassword" />
            <span asp-validation-for="CurrentPassword" class="text-danger small"></span>
        </div>

        <div class="mb-3">
            <label asp-for="NewPassword" class="form-label fw-semibold"></label>
            <input asp-for="NewPassword" type="password" class="form-control" id="newPassword" placeholder="Ingresa una nueva contraseña" value="@Model.NewPassword" />
            <span asp-validation-for="NewPassword" class="text-danger small"></span>

            <ul id="passwordRules" class="list-unstyled small mt-2 text-muted">
                <li id="rule-length"><i class="fas fa-circle text-secondary me-1"></i> Mínimo 8 caracteres</li>
                <li id="rule-upper"><i class="fas fa-circle text-secondary me-1"></i> Al menos una mayúscula</li>
                <li id="rule-lower"><i class="fas fa-circle text-secondary me-1"></i> Al menos una minúscula</li>
                <li id="rule-number"><i class="fas fa-circle text-secondary me-1"></i> Al menos un número</li>
                <li id="rule-special">
                    <i class="fas fa-circle text-secondary me-1"></i>
                    @Html.Raw("Al menos un carácter especial (¿, ¡, ., ,, ;, :, -, _, +, *, /, =, ?, !, @, #, $, %, ^, &, (, ), [, ], {, }, &lt;, &gt;, |, ~, ', &quot;, `, ¨, ´, …)")
                </li>
            </ul>
        </div>

        <div class="mb-3">
            <label asp-for="ConfirmPassword" class="form-label fw-semibold"></label>
            <input asp-for="ConfirmPassword" type="password" class="form-control" id="confirmPassword" placeholder="Repite la nueva contraseña" />
            <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
            <div id="confirmMsg" class="small mt-1"></div>
        </div>

        <div class="d-flex">
            <button type="submit" class="btn btn-primary me-2">
                <i class="fas fa-save me-1"></i>Actualizar
            </button>
            <a asp-page="/Index" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>Cancelar
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const pwd = document.getElementById('newPassword');
        const confirm = document.getElementById('confirmPassword');
        const confirmMsg = document.getElementById('confirmMsg');

        function updateRule(id, valid) {
            const el = document.getElementById(id);
            el.querySelector('i').className = valid ? 'fas fa-check-circle text-success me-1' : 'fas fa-circle text-secondary me-1';
        }

        pwd.addEventListener('input', () => {
            const value = pwd.value;
            updateRule('rule-length', value.length >= 8);
            updateRule('rule-upper', /[A-ZÁÉÍÓÚÑÇ]/.test(value));
            updateRule('rule-lower', /[a-záéíóúñç]/.test(value));
            updateRule('rule-number', /\d/.test(value));
            updateRule('rule-special', /[^\w\sáéíóúñçÁÉÍÓÚÑÇ]/.test(value));
        });

        confirm.addEventListener('input', () => {
            if (confirm.value === pwd.value && confirm.value.length > 0) {
                confirmMsg.textContent = "Las contraseñas coinciden.";
                confirmMsg.className = "text-success small mt-1";
            } else if (confirm.value.length > 0) {
                confirmMsg.textContent = "Las contraseñas no coinciden.";
                confirmMsg.className = "text-danger small mt-1";
            } else {
                confirmMsg.textContent = "";
            }
        });
    </script>
}
